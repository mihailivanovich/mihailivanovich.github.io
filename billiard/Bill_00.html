<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
      <title>Billiard_00</title>
    <style> 
    body{margin: 0vw}  
    div{ width: 10vw; height: 350px;
         position: absolute; 
         top: 2px;
         border: 1px solid black; box-shadow:0 0 6px 0 #222299;
         background-color: rgb(240,240,250);
         font-family: "Courier New"; font-size: 12px;
         text-align: center;}
     #c1{left: 50.5vw;}    
     #c2{left: 61vw;} 
       
       #tname{width: 70px}
       #nameO{width: 60px}
       #nameT{width: 60px}
       #imbg{left: 0px;  opacity: 1;border: 2px solid blue; /*box-shadow:0 0 6px 0 #222299;*/  }
       #im0,#im1,#im2,#im3,#im4,#im5,#im6{ position: absolute; cursor: move; }
        
 input[name='tn0']{width: 70px}
 input[type='button']{ width: 60px}
 input[type='number']{ width: 60px}
  .bt0{background-color: rgba(255,0,0,0.3);}
  .bt2{background-color: rgba(0,255,0,0.3);}
  .bt3{background-color: rgba(0,0,255,0.3);}
  .bt4{background-color: rgba(255,255,0,0.6);}
  .btZ{background-color: rgba(255,0,0,0.5);}
  .btS{background-color: rgba(255,100,100,0.3);     }
  #btn0,#btn1 {
  width: 110px; 
  height: 36px;  
  background-color: rgb(50, 14, 12);
  font-family: 'Courier New'; font-size: 18px; font-weight: bold; color: white;
  transition: width 0.2s, height 0.2s,  background-color 0.2s;  
 }
#btn0:hover {background-color: red;}
#btn1:hover {background-color: red;}
#bt33{margin-top: 20px}
#inp{display: none;}
label{display: inline-block; width: 120px;
 border-style: solid; border-color: black; border-width: 1px;font-family: 'Times';}
#Help{display: none; width: 100vw; height: 50vh;position: fixed; top: 2px; left: 2px; z-index: 4;
      background-color: rgb(50, 14, 12); text-align: left; color: #aff; opacity: 0.9;
      overflow-y: auto;} 
#Bl,#Op{width: 80px}      

    </style>  
  </head>

  <body>
   <div id="Help">
 <p> Задачи на январь 2021:<br> DROP FILE на BG загружается (мышкой) фон.<br> BG загружается из буфера обмена - CTRL + V.<br> Размер по Ly.</p>
    
 <p>Кнопки W+  W- по-разному работают в режиме Театра и Биллиарда. В первом случае  - для установки NewStart, NewFin1 или NewFin2, во втором - остаются при продолжении Биллиарда.</p>   
 <p>Движения Zv определяется тремя фиксированными позициями Start, Fin1 и Fin2; движение между ними закольцовано в том же порядке. Кнопками Start, Fin1 и Fin2 проверяются эти позиции, а кнопками NewStart, NewFin1 и NewFin2 задаются новые.</p>
<p>В таблице на левой (из двух) панели задаем параметры движения: t0, t1... - времена фаз в процентах, а d0, d1, d2 - степень "искривления траектории". Для каждого Zv (отмечается в верхнем окне) они свои, закрепляются кнопкой New. Отдельных фигурантов Zv можно перемещать и устанавливать в разных точках с помощью мыши. Их поворот, размер и прозрачность устатнавливают кнопками внизу.
Радиокнопки ниже выбирают варианты Zv и их изображений.</p> 
   
<p>Сохранить текущий вариант(ы) можно тремя способами:</p>
<p>1. В текстовом файле. Имя задаем в окне "name Txt", кнопкой "SaveTxt" активируется ссылка "SAVE", при нажатии на нее файл загружается в папку загрузок. Открывается кнопкой "OpenFileTxt" оттуда, куда его переместим.</p>
<p>2. В виде объекта в window.localStorage. Имя задаем в окне "name Obj", кнопкой "SaveObj" сохраняем, а "OpenObj" - открываем.</p>
<p>3. Сохраняем варианты, каждый из котрых соответствует отмеченному V0, V1 и V2. Кнопка "SaveJS" формирует скрипт с соответствующим вар. Запись выполняется при нажатии ссылки "SAVE". Файл из папки загрузки нужно переместить в текущую папку. Скрипты в папке должен соответствовать и адресам скриптов, т.е. src="V0.js","V1.js" и "V2.js",. Открывается соответствующий вариант кнопкой "NewVar".
   </div>
  <img ondragover="event.stopPropagation(); event.preventDefault();"
     ondrop="event.stopPropagation(); event.preventDefault();
     dodrop(event);"
   id="imbg" src="Pict_BG/HC_06.jpg"><br>
  <img id="im0" src="Pict_Zv/BRB_01.jpg"> 
  <img id="im1" src="Pict_Zv/DBLD_02.jpg">
  <img id="im2" src="Pict_Zv/Snuglse_02.jpg">
  <img id="im3" src="Pict_Zv/Sirano_01.jpg"> 
  <img id="im4" src="Pict_Zv/ML00.JPG">
  <img id="im5" src="Pict_Zv/Murr200.jpg">
  <img id="im6" src="Pict_Zv/Ralpha200.jpg">

 <div id="divSave" style="position: absolute;  left: 50.5vw; top: 355px; width: 220px; height: 400px; background-color: rgb(200,200,220); box-shadow: 6px 6px 4px grey; text-align: center;">
 
 <input type='button' id="bt33" class="btS" value='SaveTxt'onclick="SaveTxt();">
 <input  id="nameT" value="name Txt">
 <a id="Save" href=#>SAVE</a> <br>

 <label for="inp" class="btS">Open File txt</label>  
 <input type="file" id="inp" onchange="loadFile(this)"><br>
 <input type='button' class="btS" value='SaveObj'onclick="SaveSt();">
 <input  id="nameO" value="name Obj">
 <input type='button' class="btS" value='OpenObj'onclick="OpenSt();"><br>
 <input type='button' class="btS" value='SaveJS' onclick="SaveJS()">
   <a href=#> Save </a><br><br>
  vx = <input type="number" id="vx"><br> 
  vy = <input type="number" id="vy"><br> 
  
  <button onclick="vxs[pic]=+vx.value; vys[pic]=+vy.value;">NEW Vpic</button><br>
  <button onclick="dt=-dt">Revers</button><br> 
  <button onclick="PorT=0; Piramid(0);">Start 0
  <button onclick="PorT=0; Piramid(1);">Start 1</button><br><br>
  kZ <input type="range" value="0" min=0 max=1 step=0.05 onchange = 'kZ=this.value; Piramid(VS)'><br>
  Wi <input type="range" value="1" min=0.2 max=2 step=0.05 onchange ='kw0=this.value;Piramid(VS)'><br>
  wN <input type="range" value="1" min=0.2 max=2 step=0.05 onchange ='kwN=this.value; Piramid(VS)'><br>
  om <input type="range" value="1" min=-5 max=5 step=0.5 onchange ='kom=+this.value; '><br>
 </div>
  
 <div id="c1"> 
  
  <input  id="tname" value="Barboss"><br> 
  t0 = <input type="number" id="t00"><br> 
  t1 = <input type="number" id="t01"><br> 
  t2 = <input type="number" id="t02"><br> 
  t3 = <input type="number" id="t03"><br> 
  t4 = <input type="number" id="t04"><br> 
  t5 = <input type="number" id="t05"><br> 
  tz = <input type="number" id="tz0"><br> 
  d0 = <input type="number" id="d00" step=0.05><br> 
  d1 = <input type="number" id="d01" step=0.05><br> 
  d2 = <input type="number" id="d02" step=0.05><br> 
  Ns = <input type="number" id="nst" step=10><br> 
  <button id="bt0" onclick="New()">NEW</button><br>
  
  <input type="radio" name="rd" onclick='Rct()'>Rctng
  <input type="radio" checked name="rd" onclick='Circle()'>Circl<br>
  <input type="radio" checked name="rad" onclick='OldIm()'>ZV_51
  <input type="radio" name="rad" onclick='NewIm()'>Zv_WF

  </div>
 <div id="c2"> 
   
    <input type="checkbox" checked name="spice"><input name="tn0"><br>
    <input type="checkbox" checked name="spice"><input name="tn0"><br>
    <input type="checkbox" checked name="spice"><input name="tn0"><br>
    <input type="checkbox" checked name="spice"><input name="tn0"><br>
    <input type="checkbox" checked name="spice"><input name="tn0"><br>
    <input type="checkbox" checked name="spice"><input name="tn0"><br>
    <input type="checkbox" checked name="spice"><input name="tn0"><br>
    
    <button onclick="New1()">NEW1</button><br>

    <input type="radio" checked name="radio" value="0" onclick='ib=this.value; VarBG();'>BG_1
    <input type="radio" name="radio" value="1" onclick='ib=this.value; VarBG();'>BG_2<br>
    <input type="radio" name="radio" value="2" onclick = 'ib=this.value; VarBG();'>BG_3
    <input type="radio" name="radio" value="3" onclick = 'ib=this.value; VarBG();'>BG_4<br>
    <input type="radio" name="radio" value="4" onclick = 'ib=this.value; VarBG();'>BG_5
    <input type="radio" name="radio" value="5" onclick = 'ib=this.value; VarBG();'>BG_6<br>
    <input type="radio" name="radio" value="6" onclick = 'ib=this.value; VarBG();'>BG_7
    <input type="radio" name="radio" value="7" onclick = 'ib=this.value; VarBG();'>BG_8<br><br>

    <input type="radio" checked name="varD" value="0" onclick='iv=+this.value'>V0
    <input type="radio" name="varD" value="1" onclick='iv=+this.value'>V1
    <input type="radio" name="varD" value="2" onclick='iv=+this.value'>V2<br>
    <button onclick="if (fl==1) divSave.style.display='none'; else divSave.style.display='block';
   fl=1-fl;">Sv/Op</button>
   <button onclick="OpenJS()">NewVar</button><br>
     
 </div>

 <input type='button' class="bt0" value='+10deg'onclick="dg[pic]+=10; SetPic();">
 <input type='button' class="bt0" value='+W'onclick="wris[pic]+=0.3; if (PorT==0) PicSH(); else SetPic();">
 <input type='button' class="bt0" value='+Op'onclick="op[pic]+=0.1; SetPic();">
 <input type='button' class="bt1" value='Start'onclick="PorT=1; SetPicSt();">
 <input type='button' class="bt1" value='Fin1'onclick="PorT=1; SetPicF();">
 <input type='button' class="bt1" value='Fin2'onclick="PorT=1; SetPicF2();">
 <input type='button' class="bt2" value='Tea 1 St'onclick="OneStep();">
 <input type='button' class="bt2" value='+vel'onclick="tint/=1.2;">
 <input type='button' id="btn0" value='Theater'onclick="PorT=1; act = (!act); Run()">
 Opc <input id="Op" type="range" value="1" min=0 max=1 step=0.05 onchange='opc=this.value; SetOpc()'>
 <button onclick="SavOpenHelp()">HELP &plusmn;</button> <br> 
  
 <input type='button' class="bt0" value='-10deg'onclick="dg[pic]-=10; SetPic();">
 <input type='button' class="bt0" value='-W'onclick="wris[pic]-=0.3; if (PorT==0) PicSH(); else SetPic();">
 <input type='button' class="bt0" value='-Op'onclick="op[pic]-=0.1; SetPic();">
 <input type='button' class="bt3" value='NewSt'onclick="NewSt();">
 <input type='button' class="bt3" value='NewFin1'onclick="NewFin1();">
 <input type='button' class="bt3" value='NewFin2'onclick="NewFin2();">
 <input type='button' class="btZ" value='Bill 1 st'onclick="PorT=0; Bounce();">
 <input type='button' class="bt4" value='-vel'onclick="tint*=1.2;">
 <input type='button' id="btn1" value='Billiard'onclick="PorT=0; act1 = (!act1); Run1()">
 Blr <input id="Bl" type="range" value="0" min=0 max=10 onchange='blr=this.value; SetBlr()'>

<script src="V0.js"></script>
<script src="V1.js"></script>
<script src="V2.js"></script>

 <script> 
  let PorT=0; let VS=0; let opc=1;   fl=1;
  let Ncol=['red','green','yellow','blue','Lime','BlueViolet','Crimson','Fuchsia'];
  let rnd=[];
  let Nzv=7; let kpv=document.body.clientWidth/100;   let ib=0; let iZv=0; let rect=1;
  let wff=[]; wff[0]=[10,10,10,10,10,10,10];  wff[1]=[9,9,9,9,9,9,9];    wff[2]=[9,9,9,9,9,9,9];
  let xff=[]; xff[0]=[48.5, 18, 18, 7.5, 7.5, 7.5,29];  xff[1]=[10,30,35,52,40,15,25]; xff[2]=[53,2,54,1,10,55,35];
  let yff=[]; yff[0]=[18.9,25.2,12.6,6.9,30.9,18.9,18.9]; yff[1]=[31,33,32,43,25,25,25]; yff[2]=[18,16,16,16,25,25,25];
  let dff=[]; dff[0]=[0,0,0,0,0,0,0];       dff[1]=[360,0,360,0,0,0,0];  dff[2]=[0,0,0,0,0,0,0];
  let off=[]; off[0]=[1,1,1,1,1,1,1];       off[1]=[1,1,1,1,1,1,1];      off[2]=[1,1,1,1,1,1,1];
    // параметры искривления
  rxy0=[[0,0.1,0.2,0.3,0,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]];  rxy=rxy0;
  nf=[0,0,0,0,0,0,0]; //вид функции перехода
  //временная шкала %%
 t0=[0,0,0,0,0,0,0]; t1=[25,25,25,25,20,20,20]; t2=[50,50,50,50,55,55,55]; t3=[70,70,70,70,70,70,70]; 
 t4=[80,80,80,80,80,82,82];  t5=[90,90,90,90,90,90,90]; tz=[0,0,0,0,0,0,0];

  let kZ=0.0;  kw0=1; kwN=1; let Lx=50; let Ly=50;               flH=0; 
 // imbg.style.height=Ly+'vw';
  imbg.style.width=Lx+'vw'; 
  c1.style.left=Lx+0.5+'vw'; c2.style.left=Lx+11+'vw'; divSave.style.left=Lx+0.5+'vw';

let wris=[];  let xris=[];  let yris=[]; let dg = []; let op=[]; let xv=[];  let yv =[];

 let act=false; let act1=false; let flmouse=false; pic=0; let k=0; 
 let Nst = 300; let Nb=30; let tint=30;  pim=Math.PI;
 let sin1=[];   let cos1=[]; let lxy=[]; 
  
 let BG=["Pict_BG/HC_01.jpg","Pict_BG/HC_02.jpg","Pict_BG/HC_03.jpg","Pict_BG/HC_04.jpg","Pict_BG/HC_05.jpg","Pict_BG/HC_06.jpg","Pict_BG/HC_07.jpg","Pict_BG/HC_08.jpg"] 
 let name0=['Barboss','Prof. Dumbl','Snagles','Sirano','Mog_Lapy','Murr','Ralpha'];  let name=name0;
 let name1=['Paddy','Racoon HC','Ursus HC','Panda HC','Dog HC','Misha','Kesha'];
 let name0c=['Barboss','Prof. Dumbl','Snugles','Sirano','Mog_Lapy','Murr','Ralpha'];  
 let name1c=['Paddy','Valdek','CUBA','Misha W','mr Magoo','Fox','Kesha'];

 let zvW=['Pict_Zv/Paddy_00.png','Pict_Zv/Racoon.png','Pict_Zv/Urs_00.png','Pict_Zv/Panda_0.png','Pict_Zv/Dog_00.png','Pict_Zv/Misha.png','Pict_Zv/Keshapng.png'];
 let zv51=['Pict_Zv/Brb.png','Pict_Zv/DmbD.png','Pict_Zv/Snagles.gif','Pict_Zv/Sir_00.png','Pict_Zv/ML00.png','Pict_Zv/MurrPng.png','Pict_Zv/Dog51.png'];
 let zvWc=['Pict_Zv/Paddy_01.jpg','Pict_Zv/Vald_01.JPG','Pict_Zv/3.jpg','Pict_Zv/5.JPG','Pict_Zv/7.JPG','Pict_Zv/Fox01.JPG','Pict_Zv/Kesha.jpg'];
 let zv51c=['Pict_Zv/BRB_01.jpg','Pict_Zv/DBLD_02.jpg','Pict_Zv/Snuglse_02.jpg','Pict_Zv/Sirano_01.jpg','Pict_Zv/ML00.JPG','Pict_Zv/Murr200.jpg','Pict_Zv/Ralpha200.jpg'];
 let ZV0=[]; ZV0=zv51; let ZV1=[]; ZV1=zvW;

  var Img0=[im0,im1,im2,im3,im4,im5,im6]; var Imga=[0,1,2,3,4,5,6];  var imt0=Imga;

function SetOpc(){imbg.style.opacity = opc;}

function SetBlr(){imbg.style=' width:'+ Lx +'vw;'+ ' height:'+ Ly +'vw;'+'-webkit-filter: blur('+ +blr+'px); opacity:'+opc+';'}

function Piramid(VarSt){
  let R,dZ,X0,Y0,dxy;  VS=VarSt;
  if (VarSt==0){ //piramida
  for (j=0; j<Nzv; j++){i=imt0[j]; vxs[i]=0; vys[i]=0;
       wris[i]=7*kwN; Rs[i]=wris[i]*(1+2*db)/2;}        wris[0]=7*kw0; vxs[0]=10; ts=0;
 
  dZ=kZ*Rs[1]; Rs[0]=wris[0]*(1+2*db)/2;
    X0=Lx/2; Y0=Ly/2; R=Rs[1]+dZ;  dxy=R*Math.sqrt(3);  

  xs[1]=X0-Rs[1];  ys[1]=Y0-Rs[1]; xs[2]=xs[1]+dxy; xs[3]=xs[2]; 
  ys[2]=ys[1]+R; ys[3]=ys[1]-R;
    xs[0]=X0-Rs[0]-3*R; ys[0]=Y0-Rs[0];
  xs[4]=xs[3]+dxy;  xs[5]=xs[4];  xs[6]=xs[4];
  ys[4]=ys[1]-2*R; ys[5]=ys[1]; ys[6]=ys[1]+2*R;
  } else { //Krug
let x0 = []; let y0 = []; Rp=0.3*Ly;
  for (j=0; j<Nzv; j++){i=imt0[j]; vxs[i]=0; vys[i]=0;
       wris[i]=11*kwN; Rs[i]=wris[i]*(1+2*db)/2;}     wris[0]=11*kw0; vxs[0]=10; vys[0]=10; ts=0;
 
  dZ=kZ*Rs[1]; Rs[0]=wris[0]*(1+2*db)/2;
  x0[0]=Lx/2; y0[0]=Ly/2; R=Rs[1]+dZ;  dxy=R*Math.sqrt(3);  
  xs[0]=x0[0]-Rs[0]; ys[0]=y0[0]-Rs[0];

  for (j=1; j<Nzv; j++){i=imt0[j];
  x0[i]= x0[0]+Rp*Math.cos(Math.PI/3*i);
  y0[i]= y0[0]+Rp*Math.sin(Math.PI/3*i);
  xs[i]=x0[i]-Rs[i]; ys[i]=y0[i]-Rs[i];
}}  
     PicSH() }

                         //Бильярд
   let omeg=[20,-20,15,15,25,-25,30]; let xs0=[]; let ys0=[];  let vxs0=[];  let vys0=[];   let ays=[0,0,0,0,0,0,0];
   ts=0; dt=0.0025; krat=20; kom=1;  Fx=[]; Fy=[];  Cs=800; db=0.06; 
   
   let xs=[]; let ys=[]; let vxs=[]; let vys=[];  let Rs=[];
          
function PicSH(){for (j = 0; j < Nzv; j++) {  i = imt0[j];
  Img0[i].style = 'transform:rotate('+kom*omeg[i]*ts+'deg)';  Img0[i].style.opacity = 1;
  Img0[i].style.left=xs[i]+'vw';    Img0[i].style.top=ys[i]+'vw'; 
  Img0[i].style.width=wris[i]+'vw';  
   if (rect==1) {Img0[i].style.border=db*wris[i]+'vw'+ ' solid' + ' navy';
   if (i==0) Img0[i].style.border=db*wris[i]+'vw'+ ' solid' + ' red';
  Img0[i].style.borderRadius=wris[i]+'vw'; 
  } }
}

function Bounce(){ //1 step Billiard
  let dR;  PorT=0; 
for (i1 = 0; i1 < Nzv; i1++) {i = imt0[i1];  Rs[i]=wris[i]*(1+2*db)/2;}

function Udar(i,j){
let Fxy,Fx1,Fy1, dxR,dyR;
  dxR=(xs[j]+Rs[j]-xs[i]-Rs[i])/dR;   dyR=(ys[j]+Rs[j]-ys[i]-Rs[i])/dR; // направляющие косинусы нормали
  Fxy=Cs*(Rs[j]+Rs[i]-dR);  
  Fx1=Fxy*dxR;  Fy1=Fxy*dyR;
  Fx[j]=Fx[j]+Fx1;    Fx[i]=Fx[i]-Fx1;
  Fy[j]=Fy[j]+Fy1;    Fy[i]=Fy[i]-Fy1;} //Udar

  for (i8 = 0; i8 < krat; i8++){ 

  for (i = 0; i < Nzv; i++) {Fx[imt0[i]]=0; Fy[imt0[i]]=0;}

  for (j1 = 0; j1 < Nzv; j1++) {i = imt0[j1];
  if (xs[i]<0) {Fx[i]=-Cs*(xs[i]);};  
  if ((xs[i]+2*Rs[i])>Lx) {Fx[i]=Cs*(Lx-(xs[i]+2*Rs[i]))};
  if (ys[i]<0) {Fy[i]=-Cs*(ys[i])};
  if ((ys[i]+2*Rs[i])>Ly) {Fy[i]=Cs*(Ly-(ys[i]+2*Rs[i]))};  

       for (j2 = j1+1; j2 < Nzv; j2++){j = imt0[j2]; // alert(i+' '+j) 
      dR=Math.sqrt((xs[i]+Rs[i]-xs[j]-Rs[j])*(xs[i]+Rs[i]-xs[j]-Rs[j])
        +(ys[i]+Rs[i]-ys[j]-Rs[j])*(ys[i]+Rs[i]-ys[j]-Rs[j]));
      if (dR<(Rs[j]+Rs[i])) Udar(i,j);}  

  vxs[i]=vxs[i]+Fx[i]*dt;  
  vys[i]=vys[i]+ays[i]*dt+Fy[i]*dt;
   xs[i]=xs[i]+vxs[i]*dt;     ys[i]=ys[i]+vys[i]*dt;
}

 ts+=dt;}  PicSH();}

  sincos();   SetTab(); SetName();  Piramid(VS);


  function SavOpenHelp(){if (flH==1) Help.style.display='none'; else Help.style.display='block';
   flH=1-flH;} 
  
  let iv=0; Sjs='Data51.js';  AB=['A','B','C']; s0=''; s1=''; s2=''; SA=[s0,s1,s2]; let Name;
let Data={};   let obj={}; let SD='';

function OpenJS(){ obj={};
  if (iv==0) {obj=V0} else  
  if (iv==1) {obj=V1} else  
  if (iv==2) {obj=V2};
ObjToIsh()}

function SaveJS(){SetDataFromIsh(); SD='V'+iv;
const obj_str = SD+'='+JSON.stringify(Data);
document.getElementsByTagName('a')[1].onclick = function() {
    this.href = 'data:application/txt;charset=utf-8,' + encodeURIComponent(obj_str);
    this.target = '_blank';
    this.download = SD+'.js';}}  

wris0=[]; xs0=[]; ys0=[]; vxs0=[]; vys0=[];
  
function SetDataFromIsh(){Data={};//Name=nameO.value; 
  if (PorT==1){
Data = {PorT,Nzv,iZv,ib,tint,rect,xff,yff,wff,rxy,dff,off,t0,t1,t2,t3,t4,t5,tz}} else {
  wris0=wris; xs0=xs; ys0=ys; vxs0=vxs; vys0=vys;
Data = {PorT,Nzv,iZv,ib,tint,dt,kom,rect,xs0,ys0,vxs0,vys0,omeg,wris0}  
}}

function SaveTxt(){ Name=nameT.value; SetDataFromIsh();
const obj_str = JSON.stringify(Data);
document.getElementsByTagName('a')[0].onclick = function() {
    this.href = 'data:application/txt;charset=utf-8,' + encodeURIComponent(obj_str);
    this.target = '_blank';
    this.download = Name+'.txt';}}

function SaveSt(){Name=nameO.value; SetDataFromIsh();
const obj_str = JSON.stringify(Data)
window.localStorage.setItem(Name, obj_str)}

function ObjToIsh(){
PorT=obj.PorT; Nzv=obj.Nzv; iZv=obj.iZv; ib=obj.ib; tint=obj.tint; rect=obj.rect; 
 if (PorT==1){xff=obj.xff; yff=obj.yff; wff=obj.wff; rxy=obj.rxy; dff=obj.dff; off=obj.off;
 t0=obj.t0; t1=obj.t1; t2=obj.t2; t3=obj.t3; t4=obj.t4; t5=obj.t5; tz=obj.tz; 
 if (rect==1) {ZV0=zv51c; ZV1=zvWc;} else {ZV0=zv51; ZV1=zvW;}  
VarBG(); if (iZv==0) OldIm(); else NewIm(); sincos();   SetPicSt();} else
{dt=obj.dt; kom=obj.kom; omeg=obj.omeg; 
for (i = 0; i < Nzv; i++){
  wris[i]=obj.wris0[i]; xs[i]=obj.xs0[i];ys[i]=obj.ys0[i];vxs[i]=obj.vxs0[i];vys[i]=obj.vys0[i];}
 VarBG(); if (rect==1) {ZV0=zv51c; ZV1=zvWc;} else {ZV0=zv51; ZV1=zvW;}
  if (iZv==0) OldIm(); else NewIm(); PicSH();}
} 

function loadFile(o){var fr = new FileReader(); fr.readAsText(o.files[0]);//}
  fr.onload = function(e){showDataFile(e) }                    
  function showDataFile(e){S = e.target.result; //получаем строку                    
obj = JSON.parse(S)  //преобразуем в массив
ObjToIsh()
}}
 
function OpenSt(){Name=nameO.value;
const str = window.localStorage.getItem(Name) //получаем строку
obj = JSON.parse(str)  //преобразуем в массив
ObjToIsh()
}

function SetName(){
var put = document.getElementsByName('tn0');
for (i = 0; i < 7; i++){ put[i].value=name[i];}}

function VarBG(){imbg.src = BG[ib];} //BackGround

function sincos(){ 
  for (j = 0; j < Nzv; j++) { i = imt0[j]; lxy[i]=[]; sin1[i]=[]; cos1[i]=[];
lxy[i][0]=Math.sqrt((yff[1][i]-yff[0][i])*(yff[1][i]-yff[0][i])+
                    (xff[1][i]-xff[0][i])*(xff[1][i]-xff[0][i])); 
if(lxy[i][0]==0){sin1[i][0]=0; cos1[i][0]=0;} else
{sin1[i][0]=((yff[1][i]-yff[0][i])/lxy[i][0]); cos1[i][0]=((xff[1][i]-xff[0][i])/lxy[i][0]);}

lxy[i][1]=Math.sqrt((yff[2][i]-yff[1][i])*(yff[2][i]-yff[1][i])+
                    (xff[2][i]-xff[1][i])*(xff[2][i]-xff[1][i])); 
if(lxy[i][1]==0){sin1[i][1]=0; cos1[i][1]=0;} else
{sin1[i][1]=((yff[2][i]-yff[1][i])/lxy[i][1]); cos1[i][1]=((xff[2][i]-xff[1][i])/lxy[i][1]);}

lxy[i][2]=Math.sqrt((yff[0][i]-yff[2][i])*(yff[0][i]-yff[2][i])+
                    (xff[0][i]-xff[2][i])*(xff[0][i]-xff[2][i])); 
if(lxy[i][2]==0){sin1[i][2]=0; cos1[i][2]=0;} else
{sin1[i][2]=((yff[0][i]-yff[2][i])/lxy[i][2]); cos1[i][2]=((xff[0][i]-xff[2][i])/lxy[i][2]);}
}}
    
 function Rct(){rect=0; ZV0=zv51; ZV1=zvW; if (iZv==1) NewIm(); else OldIm();
          if(PorT==0) PicSH(); else  SetPic()}  

 function Circle(){rect=1; ZV0=zv51c; ZV1=zvWc; if (iZv==1) NewIm(); else OldIm();  
          if(PorT==0) PicSH(); else  SetPic()}  
 
function NewIm(){iZv=1; for (i = 0; i < 7; i++) Img0[i].src=ZV1[i]; 
      if (rect==1) name=name1c; else name=name1; SetName();} 
 
function OldIm(){iZv=0; for (i = 0; i < 7; i++) Img0[i].src=ZV0[i];
      if (rect==1) name=name0c; else name=name0; SetName();} 

function New1(){
 imt0=[]; Nzv=0;  var check = document.getElementsByName('spice');
for (i = 0; i < 7; i++){
if (check[i].checked) Nzv = imt0.push(i);  else Img0[i].style='width: 0vw;';  } 
if(PorT==0) PicSH(); else  SetPic();}

function SetTab(){t00.value=t0[pic];  t01.value=t1[pic]; t02.value=t2[pic];  t03.value=t3[pic]; 
 t04.value=t4[pic]; t05.value=t5[pic]; tz0.value=tz[pic]; 
 d00.value=rxy[0][pic];  d01.value=rxy[1][pic]; d02.value=rxy[2][pic]; 
 tname.value=name[pic]; nst.value=Nst;} 

function SetTabXY(){vx.value=(vxs[pic]).toFixed(5); vy.value=(vys[pic]).toFixed(5); } 

function New(){t0[pic] = +t00.value; t1[pic] = +t01.value; t2[pic] = +t02.value; t3[pic] = +t03.value; 
  t4[pic] = +t04.value; t5[pic] = +t05.value; tz[pic] = +tz0.value; 
  rxy[0][pic]=+d00.value; rxy[1][pic]=+d01.value; rxy[2][pic]=+d02.value; Nst=+nst.value; }

function Run(){
 let tim = setInterval(function() {
   if (!act) {clearInterval(tim); document.getElementById("btn0").value='Theater'} else
   document.getElementById("btn0").value='STOP';
   OneStep()
},tint); }//Run Teatr

function Run1(){
 let tim = setInterval(function() {
   if (!act1) {clearInterval(tim); btn1.value='Billiard'} else
   document.getElementById("btn1").value='STOP';
   Bounce()
},tint); }//Run1 Billiard

function SetPic(){for (j = 0; j < Nzv; j++) {  i = imt0[j];
  if (rect==1) if (k%12==i+1){rnd[i]=Math.floor(Math.random() * (8));}
  Img0[i].style = 'transform:rotate('+dg[i]+'deg)';  Img0[i].style.opacity = op[i];
  Img0[i].style.left=xris[i]+'vw';    Img0[i].style.top=yris[i]+'vw'; 
  Img0[i].style.width=wris[i]+'vw';  
   if (rect==1) {Img0[i].style.border=db*wris[i]+'vw'+ ' solid' + ' lightblue';
  Img0[i].style.borderRadius=wris[i]+'vw'; 
  Img0[i].style.borderColor=Ncol[rnd[i]];} }
}

function OneStep(){PorT=1;  k++; 
 for (j = 0; j < Nzv; j++) {  i = imt0[j];   //alert("j="+j+ " i="+i);
  wris[i]=VR0(i,wff[0][i],wff[1][i],wff[2][i],nf[i]); 
    dg[i]=VR0(i,dff[0][i],dff[1][i],dff[2][i],nf[i]); 
    op[i]=VR0(i,off[0][i],off[1][i],off[2][i],nf[i]); 
VRxy(i,xff[0][i],xff[1][i],xff[2][i],yff[0][i],yff[1][i],yff[2][i],rxy[0][i],rxy[1][i],rxy[2][i]); 
}
   if (k==Nst) k=0; 
 SetPic();
}
             //расчет параметров  Х и У к-го шага
function VRxy(j,vx0,vx1,vx2,vy0,vy1,vy2,dx1,dx2,dx3){
 n0 = t0[j]/100*Nst; n1 = t1[j]/100*Nst;  n2 = t2[j]/100*Nst; n3 = t3[j]/100*Nst; n4 = t4[j]/100*Nst; 
 n5 = t5[j]/100*Nst; let nz=tz[j]/100*Nst; let ki=k+nz; if (ki>Nst) ki=-Nst+ki;
  if (ki<=n0) {ax = vx0; ay = vy0;}  
  if (ki>n0 && ki<=n1) {t=(ki-n0)/(n1-n0); 
    dx=dx1*lxy[i][0]*Math.sin(t*pim)*sin1[i][0]; dy=-dx1*lxy[i][0]*Math.sin(t*pim)*cos1[i][0];
    ax=vx0+(vx1-vx0)*t+dx; ay=vy0+(vy1-vy0)*t+dy;}
 if (ki>n1 && ki<=n2) {ax =vx1; ay=vy1;}
 if (ki>n2 && ki<=n3) {t=(ki-n2)/(n3-n2);
    dx=dx2*lxy[i][1]*Math.sin(t*pim)*sin1[j][1]; dy=-dx2*lxy[i][1]*Math.sin(t*pim)*cos1[j][1];
    ax=vx1+(vx2-vx1)*t+dx; ay=vy1+(vy2-vy1)*t+dy;} 
 if (ki>n3 && ki<=n4) {ax =vx2; ay=vy2;}    
 if (ki>n4 && ki<=n5) {t=(ki-n4)/(n5-n4);  
    dx=dx3*lxy[j][2]*Math.sin(t*pim)*sin1[j][2]; dy=-dx3*lxy[j][2]*Math.sin(t*pim)*cos1[j][2];
    ax=vx2+(vx0-vx2)*t+dx; ay=vy2+(vy0-vy2)*t+dy;}  
 if (ki>n5 && ki<=Nst) {ax = vx0; ay = vy0;} 
 xris[j]=ax; yris[j]=ay;
 }
                               //расчет параметров  W, Opac и Deg к-го шага
function VR0(i,v0,v1,v2,nf){ 
 n0 = t0[i]/100*Nst; n1 = t1[i]/100*Nst;  n2 = t2[i]/100*Nst; n3 = t3[i]/100*Nst; n4 = t4[i]/100*Nst; 
 n5 = t5[i]/100*Nst; let nz=tz[j]/100*Nst; let ki=k+nz; if (ki>Nst) ki=-Nst+ki;
  if (ki<=n0) a = v0 
  if (ki>n0 && ki<=n1) {t=(ki-n0)/(n1-n0); if (nf==0) kf=t; else if (nf==1) kf=t*t; else kf= Math.sqrt(t); 
  a = v0+(v1-v0)*kf }
 if (ki>n1 && k<=n2) a =v1
 if (ki>n2 && ki<=n3) {t=(ki-n2)/(n3-n2); if (nf==0) kf=t; else if (nf==1) kf=t*t; else kf= Math.sqrt(t);  
  a = v1+(v2-v1)*kf} 
 if (ki>n3 && ki<=n4) a =v2 
 if (ki>n4 && ki<=n5) {t=(ki-n4)/(n5-n4); if (nf==0) kf=t; else if (nf==1) kf=t*t; else kf= Math.sqrt(t);  
  a = v2+(v0-v2)*kf}
 if (ki>n5 && ki<=Nst) a = v0 
 return a;}

function SetPicF(){ 
 for (j = 0; j < Nzv; j++){i = imt0[j]; wris[i] = wff[1][i];
 xris[i] = xff[1][i]; yris[i] = yff[1][i]; dg[i]=dff[1][i]; op[i]=off[1][i];}  SetPic(); }

function SetPicF2(){ 
 for (j = 0; j < Nzv; j++){i = imt0[j]; wris[i] = wff[2][i];
 xris[i] = xff[2][i]; yris[i] = yff[2][i]; dg[i]=dff[2][i]; op[i]=off[2][i];}  SetPic(); }

function SetPicSt(){ 
  for (j = 0; j < Nzv; j++) {  i = imt0[j];  wris[i] = wff[0][i];
  xris[i] = xff[0][i]; yris[i] = yff[0][i]; dg[i]=dff[0][i]; op[i]=off[0][i];} k=0; SetPic(); }

function NewSt(){ 
 for (j = 0; j < Nzv; j++) {i = imt0[j]; wff[0][i]=wris[i]; 
  xff[0][i]=xris[i]; yff[0][i] = yris[i]; dff[0][i]=dg[i]; off[0][i]=op[i];} sincos(); k=0; }

function NewFin1(){ 
 for (j = 0; j < Nzv; j++) {i = imt0[j]; wff[1][i]=wris[i]; 
    dff[1][i]=dg[i]; off[1][i]=op[i]; xff[1][i]=xris[i]; yff[1][i]=yris[i];} sincos();}

function NewFin2(){
 for (j = 0; j < Nzv; j++){i = imt0[j]; wff[2][i] = wris[i];
    dff[2][i]=dg[i]; off[2][i]=op[i]; xff[2][i]=xris[i]; yff[2][i]=yris[i];} sincos();}

                            /* From MOVE6n  Move Pict */
 for (i = 0; i < Nzv; i++) {Img0[i].onmousedown = function() {pic =  event.target.id.slice(2); 
   SetTab(); SetTabXY(); saveXY();}}

  document.onmouseup = clearXY;
  
  function saveXY() { kpv=document.body.clientWidth/100;    
      x = window.event.clientX/kpv;  y = window.event.clientY/kpv;      
    x_0 = Img0[pic].offsetLeft/kpv;   y_0 = Img0[pic].offsetTop/kpv;
    d_x = x_0 - x;     d_y = y_0 - y;
    document.onmousemove = movePict;
    document.addEventListener("onmousemove", movePict, false);}

  function clearXY() {document.onmousemove = null;}
  
  function movePict(obj_event) {
   x = window.event.clientX/kpv; y = window.event.clientY/kpv; 
    new_x = d_x + x;     new_y = d_y + y;
    xris[pic] = new_x;   yris[pic] = new_y; xs[pic] = new_x;   ys[pic] = new_y;
    Img0[pic].style.left = xris[pic]  + "vw";  Img0[pic].style.top = yris[pic]  + "vw"; }
          
           /*Drop or Ctrl+V BG */// let w0,h0;
function dodrop(event){
  var dt = event.dataTransfer;
  var files = dt.files;
  imbg.src = URL.createObjectURL(files[0]);
  SetImage();
}           
function SetImage(){
imbg.onload = function() {
   w0=this.width; h0=this.height; 
  Lx=Ly*w0/h0; imbg.style.width=Lx+'vw'; //imbg.style.height=Ly0+'vw';
  c1.style.left=Lx+0.5+'vw'; c2.style.left=Lx+11+'vw'; divSave.style.left=Lx+0.5+'vw';
}}           
function retrieveImageFromClipboardAsBlob(pasteEvent, callback){
  if(pasteEvent.clipboardData == false){if(typeof(callback) == "function"){
            callback(undefined);}};
    var items = pasteEvent.clipboardData.items;
    if(items == undefined){if(typeof(callback) == "function"){callback(undefined);}};
    for (var i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") == -1) continue;
        var blob = items[i].getAsFile();
        if(typeof(callback) == "function"){callback(blob);}}}

window.addEventListener("paste", function(e){
    retrieveImageFromClipboardAsBlob(e, function(imageBlob){
        if(imageBlob){var URLObj = window.URL || window.webkitURL;
        imbg.src = URLObj.createObjectURL(imageBlob);
             SetImage();}});}, false);
        /*END  Ctrl+V BG */

 </script>
  </body>
</html>
 
